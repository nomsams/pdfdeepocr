<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DeepSeek OCR → Markdown (PDF) — Max-Failsafe Client</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --muted:#232836; --text:#e6e6e6; --accent:#62d0ff; --ok:#30d158; --warn:#ffcc00; --err:#ff453a;
      --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
    h1{font-size:20px; margin:0 0 8px}
    .sub{opacity:.75; margin-bottom:16px}
    .grid{display:grid; gap:12px}
    .card{background:var(--panel); border:1px solid var(--muted); border-radius:14px; padding:14px; box-shadow:var(--shadow);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row .grow{flex:1}
    label{display:block; font-weight:600; margin-bottom:6px}
    input[type="text"],input[type="url"],input[type="password"],input[type="number"],select{
      width:100%; background:#0d1017; border:1px solid var(--muted); color:var(--text); padding:10px 12px; border-radius:10px; outline:none;
    }
    input:focus,select:focus{border-color:var(--accent)}
    .drop{border:2px dashed var(--muted); border-radius:14px; padding:22px; text-align:center; transition:.2s border-color,.2s background; cursor:pointer; user-select:none;}
    .drop.dragover{border-color:var(--accent); background:#0c111b}
    .muted{opacity:.7}
    .btn{background:var(--accent); color:#00121a; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; transition:transform .02s; box-shadow:var(--shadow);}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#2c3547; color:var(--text)}
    .btn.warn{background:var(--warn); color:#1a1400}
    .btn.err{background:var(--err); color:#1a0000}
    .btn.ok{background:var(--ok); color:#001a08}
    .bar{height:10px; background:#0c1018; border:1px solid var(--muted); border-radius:999px; overflow:hidden}
    .bar>span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #79ffa8); transition:width .15s}
    pre,textarea{background:#0b0f15; color:#eaeffb; border:1px solid var(--muted); border-radius:10px}
    pre{padding:12px; overflow:auto; max-height:420px; white-space:pre-wrap}
    textarea{width:100%; min-height:260px; padding:12px; resize:vertical}
    .cols{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:980px){ .cols{grid-template-columns:1fr 1fr} }
    .kv{display:grid; grid-template-columns:180px 1fr; gap:6px 10px; align-items:center}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; font:600 11px ui-monospace; margin-right:6px}
    .info{background:#0f1a2a; border:1px solid #22304b}
    .warn{background:#2a220f; border:1px solid #4b4022}
    .err{background:#2a0f0f; border:1px solid #4b2222}
    .ok{background:#0f2a1a; border:1px solid #224b30}
    .small{font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono"}
    details > summary{cursor:pointer}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#101522; border:1px solid var(--muted); font-size:12px; opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DeepSeek OCR → Markdown</h1>
    <div class="sub">Uploads a PDF to <span class="pill">/models/v1/deepseek/deepseek-ocr/inference</span> with a multi-proxy auto-fallback chain (5 free options), no-preflight form mode, backoff, and extensive logs.</div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div class="grow">
            <label for="endpoint">DeepSeek Endpoint</label>
            <input id="endpoint" type="url" value="https://api.alphaxiv.org/models/v1/deepseek/deepseek-ocr/inference"/>
          </div>
          <div class="grow">
            <label for="filename">Output filename (.md)</label>
            <input id="filename" type="text" value="ocr-output.md"/>
          </div>
          <div style="min-width:160px">
            <label for="maxSize">Max file size (MB)</label>
            <input id="maxSize" type="number" value="100" min="1" max="2048"/>
          </div>
        </div>

        <div class="row">
          <div class="grow">
            <label for="corsKey">proxy.cors.sh API key (optional)</label>
            <input id="corsKey" type="text" placeholder="x-cors-api-key (optional for proxy.cors.sh)"/>
            <small class="muted">Leave empty to try without a key (may rate-limit). If you have a free key, add it here.</small>
          </div>
          <div class="grow">
            <label for="customProxy">Add custom proxy candidate (optional)</label>
            <input id="customProxy" type="url" placeholder="https://your-public-proxy.example.com/style"/>
            <small class="muted">Will be tried after built-ins. Should forward POST multipart and add CORS headers.</small>
          </div>
        </div>

        <div class="row">
          <label class="small"><input id="retryToggle" type="checkbox" checked/> Retry/backoff</label>
          <label class="small"><input id="hashToggle" type="checkbox"/> SHA-256 hash</label>
          <label class="small"><input id="persistToggle" type="checkbox" checked/> Remember settings</label>
          <label class="small"><input id="formFallbackToggle" type="checkbox" checked/> Enable no-preflight form fallback</label>
        </div>
      </div>

      <div class="card">
        <label>PDF File</label>
        <div id="drop" class="drop">
          <div><strong>Drag & drop</strong> a PDF here or click to select</div>
          <div class="muted" style="margin-top:6px">Magic-byte checked; only <b>.pdf</b>.</div>
          <input id="file" type="file" accept="application/pdf" style="display:none"/>
        </div>
        <div id="picked" class="muted" style="margin-top:8px"></div>
        <div class="kv" style="margin-top:8px">
          <div>PDF Magic:</div><div id="magic">—</div>
          <div>SHA-256:</div><div id="sha">—</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="start" class="btn">Start OCR</button>
          <button id="cancel" class="btn secondary" disabled>Cancel</button>
          <button id="saveLogs" class="btn secondary" disabled>Save Logs</button>
          <span id="status" class="muted"></span>
        </div>
        <div class="bar" style="margin-top:10px"><span id="prog"></span></div>
      </div>

      <div class="card cols">
        <div>
          <label>Markdown Result</label>
          <textarea id="output" placeholder="Markdown will appear here…" readonly></textarea>
          <div class="row" style="margin-top:8px">
            <button id="download" class="btn ok" disabled>Download .md</button>
            <button id="copy" class="btn secondary" disabled>Copy</button>
            <span id="len" class="muted"></span>
          </div>
        </div>
        <div>
          <label>Logs</label>
          <pre id="log" aria-live="polite">Ready.</pre>
          <label style="margin-top:12px">cURL (equivalent)</label>
          <pre id="curl" class="small"></pre>
          <details style="margin-top:10px">
            <summary><strong>What the app will try (in order)</strong></summary>
            <ol class="small">
              <li>Direct XHR → <code>https://api.alphaxiv.org/models/v1/deepseek/deepseek-ocr/inference</code></li>
              <li>Proxy A (POST): <code>https://proxy.cors.sh/&lt;endpoint&gt;</code> (adds optional <code>x-cors-api-key</code>)</li>
              <li>Proxy B (POST?): <code>https://cors.isomorphic-git.org/&lt;endpoint&gt;</code></li>
              <li>Proxy C (likely GET-only): <code>https://thingproxy.freeboard.io/fetch/&lt;endpoint&gt;</code></li>
              <li>Proxy D (GET-only): <code>https://api.allorigins.win/raw?url=&lt;endpoint&gt;</code></li>
              <li>Proxy E (GET-only): <code>https://yacdn.org/proxy/&lt;endpoint&gt;</code></li>
              <li>Your custom proxy (if provided)</li>
              <li>For any candidate: if XHR fails/preflights and form-fallback enabled → try hidden HTML form (no-preflight) to same candidate.</li>
            </ol>
          </details>
        </div>
      </div>

      <div class="card">
        <details>
          <summary><strong>Reality check & tips</strong></summary>
          <ul class="small">
            <li>Public proxies can be down, rate-limited, or block POST. This app probes quickly and moves on.</li>
            <li><b>proxy.cors.sh</b> often works for POST multipart. Add an <code>x-cors-api-key</code> if you have one (free keys exist but rotate).</li>
            <li>For consistent reliability, a tiny free Cloudflare Worker (your account) is ideal; but this file avoids any setup per your request.</li>
            <li>CLI always works: <code>curl -X POST "https://api.alphaxiv.org/models/v1/deepseek/deepseek-ocr/inference" -F "file=@report.pdf"</code></li>
          </ul>
        </details>
      </div>
    </div>
  </div>

  <!-- Hidden iframe + form for no-preflight -->
  <iframe name="sink" id="sink" style="display:none"></iframe>
  <form id="nofetchForm" target="sink" method="POST" enctype="multipart/form-data" style="display:none">
    <input type="file" name="file" id="nofetchFile"/>
  </form>

  <script>
    // ===== DOM =====
    const qs=s=>document.querySelector(s);
    const drop=qs('#drop'), fileInput=qs('#file'), picked=qs('#picked');
    const magicEl=qs('#magic'), shaEl=qs('#sha');
    const startBtn=qs('#start'), cancelBtn=qs('#cancel'), saveLogsBtn=qs('#saveLogs');
    const statusEl=qs('#status'), prog=qs('#prog'), out=qs('#output'), len=qs('#len'), logEl=qs('#log'), dl=qs('#download'), copyBtn=qs('#copy'), curlPre=qs('#curl');
    const endpointEl=qs('#endpoint'), filenameEl=qs('#filename'), maxSizeEl=qs('#maxSize');
    const corsKeyEl=qs('#corsKey'), customProxyEl=qs('#customProxy');
    const retryToggle=qs('#retryToggle'), hashToggle=qs('#hashToggle'), persistToggle=qs('#persistToggle'), formFallbackToggle=qs('#formFallbackToggle');
    const form=qs('#nofetchForm'), formFile=qs('#nofetchFile'), sink=qs('#sink');

    // ===== State =====
    let currentFile=null, xhr=null, attempt=0;
    const MAX_ATTEMPTS=2, BACKOFF_BASE_MS=900, WATCHDOG_IDLE_MS=15000;
    let lastProgTs=0, watchdogTimer=null, logBuffer=['Ready.'];

    // ===== Utils =====
    const now=()=>new Date().toISOString().replace('T',' ').replace('Z','');
    function logLine(level,msg){const line=`[${now()}] [${(level||'INFO').toUpperCase()}] ${msg}`; logBuffer.push(line); logEl.textContent=logBuffer.join('\n'); logEl.scrollTop=logEl.scrollHeight;}
    function setStatus(m){statusEl.textContent=m;}
    function setProg(p){prog.style.width=(Math.max(0,Math.min(100,p))||0)+'%';}
    function resetUI(){setStatus(''); setProg(0); startBtn.disabled=false; cancelBtn.disabled=true; saveLogsBtn.disabled=logBuffer.length<=1; stopWatchdog();}
    function startWatchdog(){stopWatchdog(); lastProgTs=performance.now(); watchdogTimer=setInterval(()=>{if(performance.now()-lastProgTs>WATCHDOG_IDLE_MS) logLine('WARN','No upload progress — likely stall/CORS.');},2500);}
    function stopWatchdog(){if(watchdogTimer){clearInterval(watchdogTimer); watchdogTimer=null;}}
    function isLikelyJSON(s){const t=s.trim(); if(!(t.startsWith('{')&&t.endsWith('}'))&&!(t.startsWith('[')&&t.endsWith(']'))) return false; try{JSON.parse(t); return true;}catch{return false;}}
    function prettyJSON(o){try{return JSON.stringify(o,null,2);}catch{return String(o);}}
    function shellEscape(s){return `'${String(s).replace(/'/g,"'\\''")}'`;}
    function isValidHttpUrl(u){try{const x=new URL(u); return ['http:','https:'].includes(x.protocol);}catch{return false;}}

    // ===== Settings persist =====
    const LS_KEY='deepseek_maxfailsafe_settings';
    function saveSettings(){
      if(!persistToggle.checked){localStorage.removeItem(LS_KEY); return;}
      localStorage.setItem(LS_KEY, JSON.stringify({
        endpoint:endpointEl.value, filename:filenameEl.value, maxSize:maxSizeEl.value,
        corsKey:corsKeyEl.value, customProxy:customProxyEl.value,
        retry:retryToggle.checked, hash:hashToggle.checked, persist:persistToggle.checked, formFallback:formFallbackToggle.checked
      }));
    }
    function loadSettings(){
      try{const s=JSON.parse(localStorage.getItem(LS_KEY)||'null'); if(!s) return;
        if(s.endpoint) endpointEl.value=s.endpoint;
        if(s.filename) filenameEl.value=s.filename;
        if(s.maxSize) maxSizeEl.value=s.maxSize;
        if(s.corsKey) corsKeyEl.value=s.corsKey;
        if(s.customProxy) customProxyEl.value=s.customProxy;
        if(typeof s.retry==='boolean') retryToggle.checked=s.retry;
        if(typeof s.hash==='boolean') hashToggle.checked=s.hash;
        if(typeof s.persist==='boolean') persistToggle.checked=s.persist;
        if(typeof s.formFallback==='boolean') formFallbackToggle.checked=s.formFallback;
      }catch{}
    }
    [endpointEl,filenameEl,maxSizeEl,corsKeyEl,customProxyEl,retryToggle,hashToggle,persistToggle,formFallbackToggle].forEach(el=>el.addEventListener('input',saveSettings));

    // ===== Proxies (5 built-ins + custom) =====
    function endpoint(){return endpointEl.value.trim();}
    function buildCandidates(){
      const e = endpoint();
      const K = corsKeyEl.value.trim();

      // descriptor: {label, url, method:'POST', headers:{}, capability:'post'|'get', addKey?:boolean}
      const candidates = [
        { label:'Direct', url:e, headers:{}, capability:'post' },

        // POST-capable first
        { label:'proxy.cors.sh', url:`https://proxy.cors.sh/${e}`, headers: K ? {'x-cors-api-key':K} : {}, capability:'post' },
        { label:'cors.isomorphic-git.org', url:`https://cors.isomorphic-git.org/${e}`, headers:{}, capability:'post' },

        // Likely GET-only (we’ll skip POST XHR and go to form-fallback if enabled, else skip fast)
        { label:'thingproxy.freeboard.io', url:`https://thingproxy.freeboard.io/fetch/${e}`, headers:{}, capability:'maybe-post' },
        { label:'allorigins', url:`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`, headers:{}, capability:'get-only' },
        { label:'yacdn', url:`https://yacdn.org/proxy/${e}`, headers:{}, capability:'get-only' },
      ];

      const custom = customProxyEl.value.trim();
      if(custom){
        // Assume path-style where you append target; if the URL already contains http(s), we use as-is.
        // Many public proxies expect style: https://proxy/https://target
        const customUrl = custom.includes('http') ? custom : (custom.replace(/\/+$/,'') + '/' + e);
        candidates.push({ label:'CustomProxy', url:customUrl, headers:{}, capability:'post' });
      }
      return candidates;
    }

    // ===== cURL preview =====
    function buildCurl(){
      const e = endpoint();
      const fn = currentFile?.name || 'report.pdf';
      let cmd = `# Direct (likely CORS-fails in browser)\ncurl -X POST ${shellEscape(e)} \\\n  -F file=@${shellEscape(fn)}`;
      const K = corsKeyEl.value.trim();
      const list = buildCandidates().filter(c=>c.label!=='Direct');
      for(const c of list){
        cmd += `\n\n# ${c.label}\ncurl -X POST ${shellEscape(c.url)} \\\n  -F file=@${shellEscape(fn)}`;
        if(c.label==='proxy.cors.sh' && K) cmd += ` \\\n  -H "x-cors-api-key: ${K.replace(/"/g,'\\"')}"`;
      }
      curlPre.textContent = cmd;
    }
    [endpointEl,corsKeyEl,customProxyEl].forEach(el=>el.addEventListener('input',buildCurl));

    // ===== PDF checks =====
    async function readMagicBytes(file,n=8){return new Uint8Array(await file.slice(0,n).arrayBuffer());}
    function pdfMagicOK(bytes){return new TextDecoder().decode(bytes).startsWith('%PDF-');}
    async function sha256(file){const buf=await file.arrayBuffer(); const hash=await crypto.subtle.digest('SHA-256',buf); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');}

    // ===== File pick/drop =====
    drop.addEventListener('click',()=>fileInput.click());
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.add('dragover');}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('dragover');}));
    drop.addEventListener('drop',e=>handleFile(e.dataTransfer.files?.[0]));
    fileInput.addEventListener('change',e=>handleFile(e.target.files?.[0]));

    async function handleFile(f){
      if(!f) return;
      if(f.type!=='application/pdf' && !f.name.toLowerCase().endsWith('.pdf')){ alert('Please choose a .pdf file.'); return; }
      const maxBytes = Number(maxSizeEl.value||100)*1024*1024;
      if(f.size>maxBytes){ alert(`File too large. Limit ${(maxBytes/1024/1024).toFixed(0)} MB.`); return; }
      currentFile=f;
      picked.textContent=`Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
      filenameEl.value=(f.name.replace(/\.pdf$/i,'')||'ocr-output')+'.md';
      buildCurl();

      try{const mb=await readMagicBytes(f); const ok=pdfMagicOK(mb); magicEl.textContent=ok?'OK — %PDF- signature present':'Unexpected header (not %PDF-)'; logLine(ok?'OK':'WARN', ok?'PDF header ok':'Header not %PDF-, may still be a PDF.');}
      catch(e){magicEl.textContent='Could not read header'; logLine('WARN','Magic read failed: '+e);}
      shaEl.textContent='—'; if(hashToggle.checked){try{setStatus('Hashing (SHA-256)…'); const h=await sha256(f); shaEl.textContent=h; logLine('OK','SHA-256: '+h); setStatus('');}catch(e){shaEl.textContent='hash failed'; logLine('WARN','Hash failed: '+e);}}
      saveSettings();
    }

    // ===== Actions =====
    cancelBtn.addEventListener('click',()=>{ if(xhr){ xhr.abort(); logLine('WARN','Aborted by user.'); setStatus('Canceled'); resetUI(); } });
    saveLogsBtn.addEventListener('click',()=>{ const blob=new Blob([logBuffer.join('\n')],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`deepseek-ocr-logs-${Date.now()}.txt`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); });

    document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='enter') startBtn.click(); });

    startBtn.addEventListener('click', async ()=>{
      if(!currentFile){ alert('Pick a PDF first.'); return; }
      if(!isValidHttpUrl(endpoint())){ alert('Invalid endpoint URL'); return; }

      out.value=''; len.textContent=''; dl.disabled=true; copyBtn.disabled=true; saveLogsBtn.disabled=false;
      logBuffer=['Starting…']; logEl.textContent=logBuffer.join('\n'); setStatus('Initializing…'); setProg(0); startBtn.disabled=true; cancelBtn.disabled=true;

      const candidates = buildCandidates();
      for(const c of candidates){
        // Skip GET-only proxies for POST xhr (we’ll only try form-fallback where possible)
        const allowForm = (c.capability!=='get-only'); // we only attempt form where POST might be accepted
        const willTryXHR = (c.capability==='post' || c.capability==='maybe-post');

        // Try XHR path (multipart) if plausible:
        if(willTryXHR){
          const ok = await withRetries(label => xhrUpload(c.url, label, c.headers), c.label);
          if(ok){ resetUI(); return; }
        } else {
          logLine('INFO', `${c.label} — marked GET-only; skipping XHR POST quickly.`);
        }

        // Try no-preflight HTML form path (only if enabled and proxy might accept POST)
        if(formFallbackToggle.checked && allowForm){
          const formOk = await withRetries(label => formUpload(c.url, label), c.label+' (form)');
          if(formOk){ resetUI(); return; }
        } else {
          if(formFallbackToggle.checked===false) logLine('INFO', `${c.label} — form fallback disabled by user.`);
        }
      }

      logLine('ERR','All candidates exhausted. Public proxies are unreliable for POST. Consider CLI curl or your own free Worker.');
      setStatus('Failed across all fallbacks. See logs.');
      resetUI();
    });

    async function withRetries(run,label){
      const max = retryToggle.checked? MAX_ATTEMPTS : 1;
      for(attempt=1; attempt<=max; attempt++){
        const tryMsg = `${label} attempt ${attempt}/${max}`;
        logLine('INFO', `${tryMsg} — starting`);
        const ok = await run(tryMsg);
        if(ok) return true;
        if(attempt<max){ const delay=BACKOFF_BASE_MS*Math.pow(2,attempt-1); logLine('INFO', `${tryMsg} — retry in ${(delay/1000).toFixed(1)}s`); await new Promise(r=>setTimeout(r,delay)); }
      }
      return false;
    }

    // ===== XHR upload (multipart) =====
    function xhrUpload(url, label, extraHeaders={}){
      return new Promise(resolve=>{
        try{
          const fd = new FormData(); fd.append('file', currentFile, currentFile.name);
          xhr = new XMLHttpRequest(); xhr.open('POST', url, true); xhr.responseType='text';
          // DO NOT send Authorization to third-party directly; we only set generic Accept + optional proxy header(s).
          xhr.setRequestHeader('Accept','text/markdown, text/plain, application/json;q=0.9, */*;q=0.1');
          for(const [k,v] of Object.entries(extraHeaders)) try{xhr.setRequestHeader(k, v);}catch{}
          xhr.timeout = 5*60*1000;

          let lastPct=0;
          xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ const pct=Math.round(e.loaded/e.total*100); if(pct!==lastPct){ setProg(pct); setStatus(`Uploading… ${pct}% (${label})`); lastProgTs=performance.now(); lastPct=pct; } } else { setStatus(`Uploading… (${label})`); } };
          xhr.onloadstart = ()=>{ logLine('INFO', `${label} — sending multipart`); setStatus(`Sending… (${label})`); startWatchdog(); cancelBtn.disabled=false; };
          xhr.onerror = ()=>{ stopWatchdog(); logLine('ERR', `${label} — network/CORS`); setStatus('Network/CORS'); resolve(false); };
          xhr.ontimeout = ()=>{ stopWatchdog(); logLine('ERR', `${label} — timeout`); setStatus('Timeout'); resolve(false); };
          xhr.onload = ()=>{
            stopWatchdog();
            const status = xhr.status, raw = xhr.responseText||'';
            logLine('INFO', `${label} — HTTP ${status}`);
            if(status>=200 && status<300){ handleResponseText(raw); setStatus('Done.'); resolve(true); }
            else{
              out.value = `# Error ${status}\n\n${raw.slice(0,2000)}`; copyBtn.disabled=false; setStatus(`HTTP ${status}`);
              // Treat 4xx/5xx as retryable because public proxies are flaky
              resolve(false);
            }
          };
          xhr.send(fd);
        }catch(e){ stopWatchdog(); logLine('ERR', `${label} — send failed: ${e}`); setStatus('Send failed'); resolve(false); }
      });
    }

    // ===== No-preflight HTML form via hidden iframe =====
    function formUpload(url, label){
      return new Promise(resolve=>{
        try{
          form.action = url; // no custom headers → no preflight
          const dt = new DataTransfer(); dt.items.add(currentFile); formFile.files = dt.files;

          const listener = () => {
            try{
              const doc = sink.contentDocument || sink.contentWindow.document;
              const text = doc && doc.body ? doc.body.textContent : '';
              if(!text){ logLine('WARN', `${label} — empty/opaque iframe response`); resolve(false); }
              else { handleResponseText(text); setStatus('Done.'); resolve(true); }
            }catch(e){ logLine('ERR', `${label} — iframe read blocked (proxy must add CORS): ${e}`); resolve(false); }
            sink.removeEventListener('load', listener);
          };
          sink.addEventListener('load', listener);

          logLine('INFO', `${label} — submitting plain HTML form (no custom headers)`);
          form.submit();
        }catch(e){ logLine('ERR', `${label} — form submit failed: ${e}`); resolve(false); }
      });
    }

    // ===== Response handling =====
    function handleResponseText(raw){
      let md='';
      if(isLikelyJSON(raw)){
        try{
          const j=JSON.parse(raw);
          md = j.markdown || j.data?.markdown || j.text || j.data?.text || '';
          if(!md){ md='```json\n'+prettyJSON(j)+'\n```'; logLine('WARN','JSON without markdown/text field; dumped JSON.'); }
          else { logLine('OK','Extracted markdown/text from JSON.'); }
        }catch{ md=raw; }
      } else md=raw;
      out.value=md; len.textContent=md?`${md.length} chars`:''; dl.disabled=!md; copyBtn.disabled=!md;
    }

    // ===== Download & Copy =====
    dl.addEventListener('click', ()=>{ const blob=new Blob([out.value],{type:'text/markdown;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(filenameEl.value.trim()||'ocr-output.md'); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); logLine('OK','Markdown downloaded.');});
    copyBtn.addEventListener('click', async ()=>{ try{await navigator.clipboard.writeText(out.value); setStatus('Copied.'); logLine('OK','Copied to clipboard.');}catch{setStatus('Copy failed'); logLine('WARN','Clipboard write failed.');}});

    // ===== Init =====
    loadSettings(); buildCurl();
  </script>
</body>
</html>
